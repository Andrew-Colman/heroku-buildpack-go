#!/bin/bash
# usage: bin/compile <build-dir> <cache-dir> <env-dir>

set -eo pipefail

env_dir="${3}"
buildpack_version_file="${env_dir}/GO_BUILDPACK_VERSION"
buildpack_root="$(cd "$(dirname "$0")/.." && pwd)"

if [ -n "$env_dir" ] && [ -e "$buildpack_version_file" ]; then
    if [ "$(< "$buildpack_version_file")" = "2" ]; then
	exec "${buildpack_root}/bin/compile-v2" "$@"
    fi
fi

exec "${buildpack_root}/bin/compile-v1" "$@"
